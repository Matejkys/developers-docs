---
title: Incremental Loading
permalink: /extend/generic-extractor/incremental/
---

* TOC
{:toc}

Extracting data incrementally is universally beneficial --- it lowers the load on the API, speeds up the extraction and
lowers the load on [KBC Storage](https://help.keboola.com/storage/) (therefore it saves 
[credits](https://help.keboola.com/management/limits/#project-power)).

## Options
When you want to incrementally extract data from an API, you have to set two things -- incrementally extract the 
data from API and [incrementally load](https://help.keboola.com/storage/tables/#incremental-loading) the data 
into the Storage. The latter is turned simply 
by setting `"incrementalOutput": true` in the `config` section. There are however a number of implications in
the incremental loads. It essentially boils downs to these use-cases depending on what kind of data you are
importing (extracting from API):

- The imported data contain only added entries. When `incrementalOutput` is turned on, the data will be simply appended to the 
target table in Storage. Turning `incrementalOutput` to false probably makes no sense, because the table will contain only the new entries.
- The imported data contain added and modified entries. When `incrementalOutput` is turned on, you have to set a primary key 
on the table so that new rows are added and existing [rows are updated](https://help.keboola.com/storage/tables/#primary-key-deduplication). 
If the primary key is not set,
the modified entries will be duplicated in the target table. Turning `incrementalOutput` to false probably makes no sense, because the table will contain only the new entries.
- The imported data contain all rows. In this case, you have to set a primary key for the table or turn `incrementalOutput` to false. Turning `incrementalOutput` to true probably makes no sense,because the table will contain duplicate entries. If you set the primary keys, new rows will be added and modified rows will be updated. Note that in this case more [credits](https://help.keboola.com/management/limits/#project-power) are consumed.

In either of these situations the missing rows will never get deleted. If you want to do so, the only way is 
to turn `incrementalOutput` to false and do full loads. 

Using incremental loads obviously requires some support from the API. The Generic Extractor supports incremental 
loads with using [`previousStart`](/extend/generic-extractor/functions/#parameters-context) and the
[`time` function](/extend/generic/extractor/functions/#time). Setting of the primary key is done using
[mappings](/extend/generic-extractor/config/jobs/mappings/).

## Example

### Previous Start Example
Assume you have an API, which supports a parameter `modified_since` which expects a 
[Unix Timestamp](https://en.wikipedia.org/wiki/Unix_time). The response than contains only the 
records which were modified after the specified date. The following configuration can be used:

{% highlight json %}
{
    "config": {
        "incrementalOutput": true,
        "outputBucket": "mock-server",
        "jobs": [
            {
                "endpoint": "users",
                "dataType": "users",
                "params": {
                    "modified_since": {
                        "time": "previousStart"
                    }
                }
            }
        ]
    }
}
{% endhighlight %}

The configuration adds the `modified_since` parameter as a reference to the internal 
[`time.previousStart` value](/extend/generic-extractor/functions/#parameters-context) which contains the timestamp of last **successful start** of extraction of
the particular configuration. The request generated by this configuration is something like:

    GET /users?modified_since=1492606006

Where `1492606006` is variable timestamp of last successful start. This introduces state into 
Generic Extractor configuration as it now remembers when it last successfully ran. This means 
that if you run the above configuration every 5 minutes,
it will extract data modified within last 5 minutes. If you run it every hour, it will extract data modified
within the last hour. If some of the runs fails or is skipped for any reason, there is not problem because the
extraction will pick up where it ended last time it was successful.
See [example [EX107]](https://github.com/keboola/generic-extractor/tree/master/doc/examples/107-incremental-load).

The last successful time is stored in [configuration state](/extend/common-interface/config-file/#state-file).
If for some reason, you need to to reset it, you have to 
[update the configuration via API](http://docs.keboola.apiary.io/#reference/component-configurations/manage-configurations/update-configuration).

### Previous Start Date
If you have an API as in the [above example](#previous-start-example), but one which requires the date to be 
sent as a string, the following jobs configuration (which uses the [`date` function](/extend/generic-extractor/functions/#date)
can be used:

{% highlight json %}
{
    "jobs": [
        {
            "endpoint": "users",
            "dataType": "users",
            "params": {
                "modified_since": {
                    "function": "date",
                    "args": [
                        "Y-m-d H:i:s",
                        {
                            "time": "previousStart"
                        }
                    ]
                }
            }
        }
    ]
}
{% endhighlight %}

This sends a request like:

    GET /users?modified_since=2017-04-19%2012%3A46%3A46

In a more readable [url-decoded](http://meyerweb.com/eric/tools/dencoder/) form:

   GET /users?modified_since=2017-04-19 12:46:46

Otherwise the configuration behaves the same way as the [previous example](#previous-start-example)
See [example [EX108]](https://github.com/keboola/generic-extractor/tree/master/doc/examples/108-incremental-load-date).

### Incremental Load From To
Another option is that you have an API which requires `from` and `to` parameters. The following
configuration generates `from` date as the date of the last extraction 
(using the [`time.previousStart` value](/extend/generic-extractor/functions/#parameters-context) 
and `to` date as the date of the current extraction (using the 
[`time.currentStart` value](/extend/generic-extractor/functions/#parameters-context)):

{% highlight json %}
{
    "jobs": [
        {
            "endpoint": "users",
            "dataType": "users",
            "params": {
                "from": {
                    "function": "date",
                    "args": [
                        "Y-m-d",
                        {
                            "time": "previousStart"
                        }
                    ]
                },
                "to": {
                    "function": "date",
                    "args": [
                        "Y-m-d",
                        {
                            "time": "currentStart"
                        }
                    ]
                }
            }
        }
    ]
}
{% endhighlight %}

The above configuration will send a request similar to:

    GET /109-incremental-load-from-to/users?from=2017-04-19&to=2017-04-24

See [example [EX109]](https://github.com/keboola/generic-extractor/tree/master/doc/examples/109-incremental-load-from-to)

### Incremental Relative Load
Suppose you have an API which supports the `from` and `to` parameters as the 
[the above example](#incremental-load-from-to). Suppose, you want to extract last day of data.
It is possible to do this using the following configuration:

{% highlight json %}
{
    "jobs": [
        {
            "endpoint": "users",
            "dataType": "users",
            "params": {
                "from": {
                    "function": "date",
                    "args": [
                        "Y-m-d",
                        {
                            "function": "strtotime",
                            "args": [
                                "-1 day",
                                {
                                    "time": "currentStart"
                                }
                            ]
                        }
                    ]
                },
                "to": {
                    "function": "date",
                    "args": [
                        "Y-m-d",
                        {
                            "time": "currentStart"
                        }
                    ]
                }
            }
        }
    ]
}
{% endhighlight %}

The above configuration leads to a request similar to this

    GET /110-incremental-relative/users?from=2017-04-23&to=2017-04-24

Beware however that this is not a truly reliable incremental load. If you would put such configuration 
into an orchestration and the configuration would not run for some reason, you may miss some data. 
However this may be still be a useful approach for obtaining samples of data for POCs.
See [example [110]](https://github.com/keboola/generic-extractor/tree/master/doc/examples/110-incremental-relative).
